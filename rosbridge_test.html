<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />

    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>

    <script type="text/javascript" type="text/javascript">
        // Connecting to ROS
        // -----------------

        var ros = new ROSLIB.Ros({
            url: 'ws://192.168.131.1:9090'
        });

        ros.on('connection', function () {
            console.log('Connected to websocket server.');
            getTopics();
        });

        ros.on('error', function (error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function () {
            console.log('Connection to websocket server closed.');
        });

        // Publishing a Topic
        // ------------------

        var cmdVel = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });




        // Subscribing to a Topic
        // ----------------------

        var diagnostic_listener = new ROSLIB.Topic({
            ros: ros,
            name: '/diagnostics_agg',
            messageType: 'diagnostic_msgs/DiagnosticArray'
        });

        diagnostic_listener.subscribe(function (message) {
            console.log(message)
            // console.log('Received message on ' + diagnostic_listener.name + ': ' + message.data);
            // diagnostic_listener.unsubscribe();

            // cmdVel.publish(twist);
            // console.log("Published twist!")
        });

        // Calling a service
        // -----------------

        var addTwoIntsClient = new ROSLIB.Service({
            ros: ros,
            name: '/add_two_ints',
            serviceType: 'rospy_tutorials/AddTwoInts'
        });

        var request = new ROSLIB.ServiceRequest({
            a: 1,
            b: 2
        });

        addTwoIntsClient.callService(request, function (result) {
            console.log('Result for service call on '
                + addTwoIntsClient.name
                + ': '
                + result.sum);
        });

        // Getting and setting a param value
        // ---------------------------------

        ros.getParams(function (params) {
            console.log(params);
        });

        var maxVelX = new ROSLIB.Param({
            ros: ros,
            name: 'max_vel_y'
        });

        maxVelX.set(0.8);
        maxVelX.get(function (value) {
            console.log('MAX VAL: ' + value);
        });

        function getTopics() {
            console.log("Getting topics!")
            var topicsClient = new ROSLIB.Service({
                ros: ros,
                name: '/rosapi/topics',
                serviceType: 'rosapi/Topics'
            });

            var request = new ROSLIB.ServiceRequest();

            topicsClient.callService(request, function (result) {
                console.log("Getting topics...");
                console.log(result.topics);
            });
        };
        getTopics();

        document.onkeydown = checkKey;

        function checkKey(e) {

            e = e || window.event;

            var twist = new ROSLIB.Message({
                linear: {
                    x: 0.0,
                    y: 0.0,
                    z: 0.0
                },
                angular: {
                    x: 0.0,
                    y: 0.0,
                    z: 0.3
                }
            });

            if (e.keyCode == '38') {
                // up arrow
                var twist = new ROSLIB.Message({
                    linear: {
                        x: 0.3,
                        y: 0.0,
                        z: 0.0
                    },
                    angular: {
                        x: 0.0,
                        y: 0.0,
                        z: 0.3
                    }
                });
                console.log("Moving forward!")
                cmdVel.publish(twist)
            }
            else if (e.keyCode == '40') {
                // down arrow
                console.log("Moving back!")
                var twist = new ROSLIB.Message({
                    linear: {
                        x: -0.3,
                        y: 0.0,
                        z: 0.0
                    },
                    angular: {
                        x: 0.0,
                        y: 0.0,
                        z: 0.3
                    }
                });
                cmdVel.publish(twist)
            }
            else if (e.keyCode == '37') {
                // left arrow
                console.log("Moving left!")
                var twist = new ROSLIB.Message({
                    linear: {
                        x: 0.0,
                        y: 0.0,
                        z: 0.0
                    },
                    angular: {
                        x: 0.0,
                        y: 0.0,
                        z: 2.0
                    }
                });
                cmdVel.publish(twist)
            }
            else if (e.keyCode == '39') {
                // right arrow
                console.log("Moving right!")
                var twist = new ROSLIB.Message({
                    linear: {
                        x: 0.0,
                        y: 0.0,
                        z: 0.0
                    },
                    angular: {
                        x: 0.0,
                        y: 0.0,
                        z: -2.0
                    }
                });
                cmdVel.publish(twist)
            }

        }
    </script>
</head>

<body>
    <h1>Simple roslib Example</h1>
    <p>Check your Web Console for output.</p>
</body>

</html>